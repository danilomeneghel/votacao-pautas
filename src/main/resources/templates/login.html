{#include baseLogin.html}
{#title}Login{/}
{#contents}
<div class="bg-login">
    <div class="container-login">
        <div class="logo-login">
            <img src="/assets/images/logo.png" width="200">
        </div>
        <div class="panel panel-default">
            <div class="panel-body box-login">
                <h3 class="title-login">Login</h3>
                {#if success != null}<div class="alert alert-success" role="alert">{success}</div>{/if}
                <form method="POST" name="loginForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <input type="text" name="username" id="username" class="form-control input-login" autofocus="autofocus" placeholder="Usuário"/>
                    </div>
                    <div class="form-group">
                        <input type="password" name="password" id="password" class="form-control input-login" placeholder="Senha"/>
                    </div>
                    <div class="form-group">
                        <input type="submit" id="login" value="Login" class="btn btn-login btn-lg btn-block"/>
                    </div>
                </form>
                <a href="/auth/cadastro">Cadastrar</a>
                <div id="error"></div>
            </div>
        </div>
        <div class="text-center">
            <strong>Login de Teste:</strong><br /><br />
            Usuário: admin<br />
            Senha: admin<br />
        </div>
        <br /><br />
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    window.history.pushState("", "", "/auth");
    $("form").submit(function(event){
        var data = {
            username: $("#username").val(),
            password: $("#password").val()
        };

        $.ajax({
            url: location.href+"/logar",
            data: JSON.stringify(data),
            type: "POST",
            cache: false,
            contentType: "application/json",
            success: function(result) { 
                if(!result) {
                    $("#error").text("Usuário ou senha inválido.").addClass("alert alert-danger");
                    $(".alert-success").remove();
                    return false;
                } else {
                    localStorage.setItem("token", result.token);
                    localStorage.setItem("username", result.username);
                    localStorage.setItem("cpf", result.cpf);
                }
                $.ajax({
                    url: "/",
                    type: "GET",
                    cache: false,
                    contentType: "application/json",
                    headers: {
                        "Authorization": "Bearer "+result.token
                    },
                    success: function(data) { 
                        location.replace("/");
                    },
                    error: function() { 
                        $("#error").text("Erro ao tentar abrir a página. Tente novamente.").addClass("alert alert-danger");
                        $(".alert-success").remove();
                    },
                });
            },
            error: function() { 
                $("#error").text("Erro ao tentar logar. Tente novamente.").addClass("alert alert-danger");
                $(".alert-success").remove();
            }
        });
        event.preventDefault();
    });
});
</script>
{/contents}
{/include}